<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Aki Vehtari and Jonah Gabry" />

<meta name="date" content="2020-07-14" />

<title>Using the loo package (version &gt;= 2.0.0)</title>

<script>// Hide empty <a> tag within highlighted CodeBlock for screen reader accessibility (see https://github.com/jgm/pandoc/issues/6352#issuecomment-626106786) -->
// v0.0.1
// Written by JooYoung Seo (jooyoung@psu.edu) and Atsushi Yasumoto on June 1st, 2020.

document.addEventListener('DOMContentLoaded', function() {
  const codeList = document.getElementsByClassName("sourceCode");
  for (var i = 0; i < codeList.length; i++) {
    var linkList = codeList[i].getElementsByTagName('a');
    for (var j = 0; j < linkList.length; j++) {
      if (linkList[j].innerHTML === "") {
        linkList[j].setAttribute('aria-hidden', 'true');
      }
    }
  }
});
</script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Using the loo package (version &gt;= 2.0.0)</h1>
<h4 class="author">Aki Vehtari and Jonah Gabry</h4>
<h4 class="date">2020-07-14</h4>


<div id="TOC">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#setup">Setup</a></li>
<li><a href="#example-poisson-vs-negative-binomial-for-the-roaches-dataset">Example: Poisson vs negative binomial for the roaches dataset</a><ul>
<li><a href="#background-and-model-fitting">Background and model fitting</a><ul>
<li><a href="#roaches-data">Roaches data</a></li>
<li><a href="#fit-poisson-model">Fit Poisson model</a></li>
</ul></li>
<li><a href="#using-the-loo-package-for-model-checking-and-comparison">Using the <strong>loo</strong> package for model checking and comparison</a><ul>
<li><a href="#computing-psis-loo-and-checking-diagnostics">Computing PSIS-LOO and checking diagnostics</a></li>
<li><a href="#plotting-pareto-k-diagnostics">Plotting Pareto <span class="math inline">\(k\)</span> diagnostics</a></li>
<li><a href="#marginal-posterior-predictive-checks">Marginal posterior predictive checks</a></li>
</ul></li>
<li><a href="#try-alternative-model-with-more-flexibility">Try alternative model with more flexibility</a></li>
<li><a href="#comparing-the-models-on-expected-log-predictive-density">Comparing the models on expected log predictive density</a></li>
</ul></li>
<li><a href="#references">References</a></li>
</ul>
</div>

<!--
%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{Using the loo package}
-->
<p><strong>NOTE: We recommend viewing the fully rendered version of this vignette online at <a href="https://mc-stan.org/loo/articles/" class="uri">https://mc-stan.org/loo/articles/</a></strong></p>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>This vignette demonstrates how to use the <strong>loo</strong> package to carry out Pareto smoothed importance-sampling leave-one-out cross-validation (PSIS-LOO) for purposes of model checking and model comparison.</p>
<p>In this vignette we can’t provide all necessary background information on PSIS-LOO and its diagnostics (Pareto <span class="math inline">\(k\)</span> and effective sample size), so we encourage readers to refer to the following papers for more details:</p>
<ul>
<li><p>Vehtari, A., Gelman, A., and Gabry, J. (2017). Practical Bayesian model evaluation using leave-one-out cross-validation and WAIC. <em>Statistics and Computing</em>. 27(5), 1413–1432. :10.1007/s11222-016-9696-4. Links: <a href="http://link.springer.com/article/10.1007%2Fs11222-016-9696-4">published</a> | <a href="http://arxiv.org/abs/1507.04544">arXiv preprint</a>.</p></li>
<li><p>Vehtari, A., Simpson, D., Gelman, A., Yao, Y., and Gabry, J. (2019). Pareto smoothed importance sampling. <a href="http://arxiv.org/abs/1507.04544">arXiv preprint arXiv:1507.04544</a>.</p></li>
</ul>
</div>
<div id="setup" class="section level1">
<h1>Setup</h1>
<p>In addition to the <strong>loo</strong> package, we’ll also be using <strong>rstanarm</strong> and <strong>bayesplot</strong>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">library</span>(<span class="st">&quot;rstanarm&quot;</span>)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw">library</span>(<span class="st">&quot;bayesplot&quot;</span>)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="kw">library</span>(<span class="st">&quot;loo&quot;</span>)</span></code></pre></div>
</div>
<div id="example-poisson-vs-negative-binomial-for-the-roaches-dataset" class="section level1">
<h1>Example: Poisson vs negative binomial for the roaches dataset</h1>
<div id="background-and-model-fitting" class="section level2">
<h2>Background and model fitting</h2>
<p>The Poisson and negative binomial regression models used below in our example, as well as the <code>stan_glm</code> function used to fit the models, are covered in more depth in the <strong>rstanarm</strong> vignette <a href="http://mc-stan.org/rstanarm/articles/count.html"><em>Estimating Generalized Linear Models for Count Data with rstanarm</em></a>. In the rest of this vignette we will assume the reader is already familiar with these kinds of models.</p>
<div id="roaches-data" class="section level3">
<h3>Roaches data</h3>
<p>The example data we’ll use comes from Chapter 8.3 of <a href="http://www.stat.columbia.edu/~gelman/arm/">Gelman and Hill (2007)</a>. We want to make inferences about the efficacy of a certain pest management system at reducing the number of roaches in urban apartments. Here is how Gelman and Hill describe the experiment and data (pg. 161):</p>
<blockquote>
<p>the treatment and control were applied to 160 and 104 apartments, respectively, and the outcome measurement <span class="math inline">\(y_i\)</span> in each apartment <span class="math inline">\(i\)</span> was the number of roaches caught in a set of traps. Different apartments had traps for different numbers of days</p>
</blockquote>
<p>In addition to an intercept, the regression predictors for the model are <code>roach1</code>, the pre-treatment number of roaches (rescaled above to be in units of hundreds), the treatment indicator <code>treatment</code>, and a variable indicating whether the apartment is in a building restricted to elderly residents <code>senior</code>. Because the number of days for which the roach traps were used is not the same for all apartments in the sample, we use the <code>offset</code> argument to specify that <code>log(exposure2)</code> should be added to the linear predictor.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># the &#39;roaches&#39; data frame is included with the rstanarm package</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="kw">data</span>(roaches)</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="kw">str</span>(roaches)</span>
<span id="cb2-4"><a href="#cb2-4"></a></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="co"># rescale to units of hundreds of roaches</span></span>
<span id="cb2-6"><a href="#cb2-6"></a>roaches<span class="op">$</span>roach1 &lt;-<span class="st"> </span>roaches<span class="op">$</span>roach1 <span class="op">/</span><span class="st"> </span><span class="dv">100</span></span></code></pre></div>
</div>
<div id="fit-poisson-model" class="section level3">
<h3>Fit Poisson model</h3>
<p>We’ll fit a simple Poisson regression model using the <code>stan_glm</code> function from the <strong>rstanarm</strong> package.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>fit1 &lt;-</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="st">  </span><span class="kw">stan_glm</span>(</span>
<span id="cb3-3"><a href="#cb3-3"></a>    <span class="dt">formula =</span> y <span class="op">~</span><span class="st"> </span>roach1 <span class="op">+</span><span class="st"> </span>treatment <span class="op">+</span><span class="st"> </span>senior,</span>
<span id="cb3-4"><a href="#cb3-4"></a>    <span class="dt">offset =</span> <span class="kw">log</span>(exposure2),</span>
<span id="cb3-5"><a href="#cb3-5"></a>    <span class="dt">data =</span> roaches,</span>
<span id="cb3-6"><a href="#cb3-6"></a>    <span class="dt">family =</span> <span class="kw">poisson</span>(<span class="dt">link =</span> <span class="st">&quot;log&quot;</span>),</span>
<span id="cb3-7"><a href="#cb3-7"></a>    <span class="dt">prior =</span> <span class="kw">normal</span>(<span class="dv">0</span>, <span class="fl">2.5</span>, <span class="dt">autoscale =</span> <span class="ot">TRUE</span>),</span>
<span id="cb3-8"><a href="#cb3-8"></a>    <span class="dt">prior_intercept =</span> <span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dt">autoscale =</span> <span class="ot">TRUE</span>),</span>
<span id="cb3-9"><a href="#cb3-9"></a>    <span class="dt">seed =</span> <span class="dv">12345</span></span>
<span id="cb3-10"><a href="#cb3-10"></a>  )</span></code></pre></div>
<p>Usually we would also run posterior predictive checks as shown in the <strong>rstanarm</strong> vignette <a href="http://mc-stan.org/rstanarm/articles/count.html">Estimating Generalized Linear Models for Count Data with rstanarm</a>, but here we focus only on methods provided by the <strong>loo</strong> package.</p>
<p><br></p>
</div>
</div>
<div id="using-the-loo-package-for-model-checking-and-comparison" class="section level2">
<h2>Using the <strong>loo</strong> package for model checking and comparison</h2>
<p><em>Although cross-validation is mostly used for model comparison, it is also useful for model checking.</em></p>
<div id="computing-psis-loo-and-checking-diagnostics" class="section level3">
<h3>Computing PSIS-LOO and checking diagnostics</h3>
<p>We start by computing PSIS-LOO with the <code>loo</code> function. Since we fit our model using <strong>rstanarm</strong> we can use the <code>loo</code> method for <code>stanreg</code> objects (fitted model objects from <strong>rstanarm</strong>), which doesn’t require us to first extract the pointwise log-likelihood values. If we had written our own Stan program instead of using <strong>rstanarm</strong> we would pass an array or matrix of log-likelihood values to the <code>loo</code> function (see, e.g. <code>help(&quot;loo.array&quot;, package = &quot;loo&quot;)</code>). We’ll also use the argument <code>save_psis = TRUE</code> to save some intermediate results to be re-used later.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>loo1 &lt;-<span class="st"> </span><span class="kw">loo</span>(fit1, <span class="dt">save_psis =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p><code>loo</code> gives us warnings about the Pareto diagnostics, which indicate that for some observations the leave-one-out posteriors are different enough from the full posterior that importance-sampling is not able to correct the difference. We can see more details by printing the <code>loo</code> object.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">print</span>(loo1)</span></code></pre></div>
<p>The table shows us a summary of Pareto <span class="math inline">\(k\)</span> diagnostic, which is used to assess the reliability of the estimates. In addition to the proportion of leave-one-out folds with <span class="math inline">\(k\)</span> values in different intervals, the minimum of the effective sample sizes in that category is shown to give idea why higher <span class="math inline">\(k\)</span> values are bad. Since we have some <span class="math inline">\(k&gt;1\)</span>, we are not able to compute an estimate for the Monte Carlo standard error (SE) of the expected log predictive density (<code>elpd_loo</code>) and <code>NA</code> is displayed. (Full details on the interpretation of the Pareto <span class="math inline">\(k\)</span> diagnostics are available in the Vehtari, Gelman, and Gabry (2017) and Vehtari, Simpson, Gelman, Yao, and Gabry (2019) papers referenced at the top of this vignette.)</p>
<p>In this case the <code>elpd_loo</code> estimate should not be considered reliable. If we had a well-specified model we would expect the estimated effective number of parameters (<code>p_loo</code>) to be smaller than or similar to the total number of parameters in the model. Here <code>p_loo</code> is almost 300, which is about 70 times the total number of parameters in the model, indicating severe model misspecification.</p>
</div>
<div id="plotting-pareto-k-diagnostics" class="section level3">
<h3>Plotting Pareto <span class="math inline">\(k\)</span> diagnostics</h3>
<p>Using the <code>plot</code> method on our <code>loo1</code> object produces a plot of the <span class="math inline">\(k\)</span> values (in the same order as the observations in the dataset used to fit the model) with horizontal lines corresponding to the same categories as in the printed output above.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw">plot</span>(loo1)</span></code></pre></div>
<p>This plot is useful to quickly see the distribution of <span class="math inline">\(k\)</span> values, but it’s often also possible to see structure with respect to data ordering. In our case this is mild, but there seems to be a block of data that is somewhat easier to predict (indices around 90–150). Unfortunately even for these data points we see some high <span class="math inline">\(k\)</span> values.</p>
</div>
<div id="marginal-posterior-predictive-checks" class="section level3">
<h3>Marginal posterior predictive checks</h3>
<p>The <code>loo</code> package can be used in combination with the <code>bayesplot</code> package for leave-one-out cross-validation marginal posterior predictive checks <a href="http://arxiv.org/abs/1709.01449">Gabry et al (2018)</a>. LOO-PIT values are cumulative probabilities for <span class="math inline">\(y_i\)</span> computed using the LOO marginal predictive distributions <span class="math inline">\(p(y_i|y_{-i})\)</span>. For a good model, the distribution of LOO-PIT values should be uniform. In the following plot the distribution (smoothed density estimate) of the LOO-PIT values for our model (thick curve) is compared to many independently generated samples (each the same size as our dataset) from the standard uniform distribution (thin curves).</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>yrep &lt;-<span class="st"> </span><span class="kw">posterior_predict</span>(fit1)</span>
<span id="cb7-2"><a href="#cb7-2"></a></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="kw">ppc_loo_pit_overlay</span>(</span>
<span id="cb7-4"><a href="#cb7-4"></a>  <span class="dt">y =</span> roaches<span class="op">$</span>y,</span>
<span id="cb7-5"><a href="#cb7-5"></a>  <span class="dt">yrep =</span> yrep,</span>
<span id="cb7-6"><a href="#cb7-6"></a>  <span class="dt">lw =</span> <span class="kw">weights</span>(loo1<span class="op">$</span>psis_object)</span>
<span id="cb7-7"><a href="#cb7-7"></a>)</span></code></pre></div>
<p>The excessive number of values close to 0 indicates that the model is under-dispersed compared to the data, and we should consider a model that allows for greater dispersion.</p>
</div>
</div>
<div id="try-alternative-model-with-more-flexibility" class="section level2">
<h2>Try alternative model with more flexibility</h2>
<p>Here we will try <a href="https://en.wikipedia.org/wiki/Negative_binomial_distribution">negative binomial</a> regression, which is commonly used for overdispersed count data.<br />
Unlike the Poisson distribution, the negative binomial distribution allows the conditional mean and variance of <span class="math inline">\(y\)</span> to differ.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>fit2 &lt;-<span class="st"> </span><span class="kw">update</span>(fit1, <span class="dt">family =</span> neg_binomial_<span class="dv">2</span>)</span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>loo2 &lt;-<span class="st"> </span><span class="kw">loo</span>(fit2, <span class="dt">save_psis =</span> <span class="ot">TRUE</span>, <span class="dt">cores =</span> <span class="dv">2</span>)</span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="kw">print</span>(loo2)</span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="kw">plot</span>(loo2, <span class="dt">label_points =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p>Using the <code>label_points</code> argument will label any <span class="math inline">\(k\)</span> values larger than 0.7 with the index of the corresponding data point. These high values are often the result of model misspecification and frequently correspond to data points that would be considered ``outliers’’ in the data and surprising according to the model <a href="http://arxiv.org/abs/1709.01449">Gabry et al (2019)</a>. Unfortunately, while large <span class="math inline">\(k\)</span> values are a useful indicator of model misspecification, small <span class="math inline">\(k\)</span> values are not a guarantee that a model is well-specified.</p>
<p>If there are a small number of problematic <span class="math inline">\(k\)</span> values then we can use a feature in <strong>rstanarm</strong> that lets us refit the model once for each of these problematic observations. Each time the model is refit, one of the observations with a high <span class="math inline">\(k\)</span> value is omitted and the LOO calculations are performed exactly for that observation. The results are then recombined with the approximate LOO calculations already carried out for the observations without problematic <span class="math inline">\(k\)</span> values:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="cf">if</span> (<span class="kw">any</span>(<span class="kw">pareto_k_values</span>(loo2) <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.7</span>)) {</span>
<span id="cb11-2"><a href="#cb11-2"></a>  loo2 &lt;-<span class="st"> </span><span class="kw">loo</span>(fit2, <span class="dt">save_psis =</span> <span class="ot">TRUE</span>, <span class="dt">k_threshold =</span> <span class="fl">0.7</span>)</span>
<span id="cb11-3"><a href="#cb11-3"></a>}</span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="kw">print</span>(loo2)</span></code></pre></div>
<p>In the print output we can see that the Monte Carlo SE is small compared to the other uncertainties.</p>
<p>On the other hand, <code>p_loo</code> is about 7 and still a bit higher than the total number of parameters in the model. This indicates that there is almost certainly still some degree of model misspecification, but this is much better than the <code>p_loo</code> estimate for the Poisson model.</p>
<p>For further model checking we again examine the LOO-PIT values.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>yrep &lt;-<span class="st"> </span><span class="kw">posterior_predict</span>(fit2)</span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="kw">ppc_loo_pit_overlay</span>(roaches<span class="op">$</span>y, yrep, <span class="dt">lw =</span> <span class="kw">weights</span>(loo2<span class="op">$</span>psis_object))</span></code></pre></div>
<p>The plot for the negative binomial model looks better than the Poisson plot, but we still see that this model is not capturing all of the essential features in the data.</p>
</div>
<div id="comparing-the-models-on-expected-log-predictive-density" class="section level2">
<h2>Comparing the models on expected log predictive density</h2>
<p>We can use the <code>loo_compare</code> function to compare our two models on expected log predictive density (ELPD) for new data:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="kw">loo_compare</span>(loo1, loo2)</span></code></pre></div>
<p>The difference in ELPD is much larger than several times the estimated standard error of the difference again indicating that the negative-binomial model is expected to have better predictive performance than the Poisson model. However, according to the LOO-PIT checks there is still some misspecification, and a reasonable guess is that a hurdle or zero-inflated model would be an improvement (we leave that for another case study).</p>
<p><br></p>
</div>
</div>
<div id="references" class="section level1">
<h1>References</h1>
<p>Gabry, J., Simpson, D., Vehtari, A., Betancourt, M. and Gelman, A. (2019), Visualization in Bayesian workflow. <em>J. R. Stat. Soc. A</em>, 182: 389-402. :10.1111/rssa.12378. (<a href="https://rss.onlinelibrary.wiley.com/doi/full/10.1111/rssa.12378">journal version</a>, <a href="https://arxiv.org/abs/1709.01449">arXiv preprint</a>, <a href="https://github.com/jgabry/bayes-vis-paper">code on GitHub</a>) <a id="gabry2019"></a></p>
<p>Gelman, A. and Hill, J. (2007). <em>Data Analysis Using Regression and Multilevel/Hierarchical Models.</em> Cambridge University Press, Cambridge, UK.</p>
<p>Vehtari, A., Gelman, A., and Gabry, J. (2017). Practical Bayesian model evaluation using leave-one-out cross-validation and WAIC. <em>Statistics and Computing</em>. 27(5), 1413–1432. :10.1007/s11222-016-9696-4. <a href="http://link.springer.com/article/10.1007%2Fs11222-016-9696-4">online</a>, <a href="http://arxiv.org/abs/1507.04544">arXiv preprint arXiv:1507.04544</a>.</p>
<p>Vehtari, A., Simpson, D., Gelman, A., Yao, Y., and Gabry, J. (2019). Pareto smoothed importance sampling. <a href="http://arxiv.org/abs/1507.02646">arXiv preprint arXiv:1507.02646</a>.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
